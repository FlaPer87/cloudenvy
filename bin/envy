#!env python
# vim: tabstop=4 shiftwidth=4 softtabstop=4

import argparse
import logging
import sys

from cloudenvy import fabfile


if __name__ == '__main__':
    parser = argparse.ArgumentParser(
            description='Launch a virtual machine in an openstack environment.')
    parser.add_argument('-v', '--verbosity', action='count',
                        help='increase output verbosity')
    parser.add_argument('-e', '--env', action='store',
                        help='specify which environemnt config to use',
                        default=fabfile.DEFAULT_ENV_NAME)
    subparsers = parser.add_subparsers(title='Available commands:')

    for cmd in fabfile.COMMANDS:
        cmd_name = cmd.func_name
        helptext = getattr(cmd, '__doc__', '')
        subparser = subparsers.add_parser(cmd_name, help=helptext)
        subparser.set_defaults(func=cmd)

        # NOTE(termie): add some specific options, if this ever gets too
        #               large we should probably switch to manually
        #               specifying each parser
        if cmd_name == 'provision':
            subparser.add_argument('-u', '--userdata', action='store',
                                   help='specify the location of userdata',
                                   default=fabfile.USERDATA_LOCATION)

    args = parser.parse_args()

    if args.verbosity == 3:
        logging.getLogger().setLevel(logging.DEBUG)
        logging.getLogger('novaclient').setLevel(logging.DEBUG)
    elif args.verbosity == 2:
        logging.getLogger().setLevel(logging.DEBUG)
        logging.getLogger('novaclient').setLevel(logging.INFO)
    elif args.verbosity == 1:
        logging.getLogger().setLevel(logging.INFO)

    args.func(args)
